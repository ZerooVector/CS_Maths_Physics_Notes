#RL  

### 补充：拉格朗日乘子是什么
在我们使用 Ricatti 递归求解 LQR 问题时，我们得到：
$$
\lambda_{i} = P_{i}x_{i}
$$
我们使用动态规划方法求解时，我们也得到了：
$$
V_{i}(x) = \frac{1}{2} x^{T}P_{i}x
$$
那么我们容易注意到：
$$
\lambda_{i} = \nabla_{x}V_{i}(x) 
$$
那么我们注意到，在动态规划中，拉格朗日乘子是最优损失函数的梯度，这在任何一个系统（包括非线性的系统）中都成立。


## Convex MPC
在现实中，我们通常面临各种各样的不等式约束，因此 Ricatti 递归方法可能会受到限制（注意：QP 方法仍然可以使用！）而且求解 QP 问题可能会比较慢，尤其是对于 Infinite Horizon 的情形。因此，我们要放弃一些“最优性”，转而追求速度和约束条件的满足。

### 关于“凸性”的解释
- 凸集：直观上，如果一条线段的两个端点在凸集内，那么直线上的所有点都在凸集内。
例如：$Ax = b$ 的解空间；$Ax \le b$ 所规定的空间；$x^{T}P x \le 1$ 规定的空间，等等。

- 凸函数：直观上，一个函数 $f (x):\mathbb{R}^{n} \rightarrow \mathbb{R}$ 的曲线上方的区域是凸集，那么这个函数就是凸函数。
例如：线性函数、二次函数、$||x||_{n}$（$n$ 范数）

- 凸优化问题：在一个**凸集**上最小化一个**凸函数**的问题
例如：线性规划、（线性约束的）二次规划、二次约束的二次规划（QCQP）、二阶锥规划（SOCP）
注意：动态规划实际上是 MDP 问题的一种解决方法，它与这些数学规划问题都无关

凸优化的重要性质是：KKT 条件是其得到最优解的**充分必要条件**，这意味着只要你找到了一个局部最优，你就找到了全局最优。一般来说，牛顿算法收敛得非常快！

### 回到 Convex MPC
我们将 Convex MPC 考虑成“有约束的 LQR”
回忆在 DP 中的情况，如果我们可以写出系统的最优状态损失函数，我们可以迭代求解问题：
$$
u_{n}= \arg \min_{u} l(x_{i},u) + V_{i+1}(f(x_{i},u)) = \arg \min_{u} \frac{1}{2} u^{T}Ru + \frac{1}{2} (A_{i}x_{i}+ B_{i}u) P_{i+1} (A_{i}x_{i}+ B_{i}u)
$$
我们现在要施加对于 $u$ 的约束。一种不好的做法是像极小值原理中一样，直接裁剪 $u$，这样的效果不好，因为 $V(x)$ 计算的是无约束的情况。
一种做法是，我们不仅求解一个一步最小化问题，而是求解多步的最小化问题：
$$
\min_{u_{1:H}} \sum_{n} \frac{1}{2} x_{n}^{T} Q_{n}x_{n}  + \frac{1}{2} u_{n}^{T} R_{n}u_{n}  + x_{H}^{T}P_{H}x
$$
$$
s.t. \quad x_{i+1} = A_{i}x_{i}+ B_{i}u_{i} 
$$
直觉上，我们使用 MPC 求解问题时，在前几个时间步内我们就把状态调整到参考值附近，此后约束不再启动，我们每次只考虑几个时间步来略微调整即可。
MPC 对于模型的要求非常高。我们需要一个很好的对 $V(x)$ 的估计。当然，设定的 $H$ 越大，控制器越鲁棒，越不依赖于 $V(x)$ 的准确性

#### E .g. 双旋翼无人机的控制
系统显然被建模为：
$$
m\ddot x  = - (u_{1}+u_{2}) \sin \theta \quad m\ddot y = (u_{1}+ u_{2}) \cos \theta - mg \quad J \ddot \theta  = \frac{1}{2} l(u_{2} - u_{1})
$$
我们将系统线性化。在平衡位置上
$$
u_{1}= u_{2} = \frac{1}{2} mg
$$
那么将系统线性化：
$$
\Delta  \ddot  x =  - g \Delta \theta \quad \Delta \ddot y  = \frac{1}{m} (\Delta u_{1} + \Delta u_{2}) \quad  \Delta \ddot \theta = \frac{1}{J} \frac{l}{2} (\Delta  u_{2} - \Delta  u_{1})
$$
记状态向量：
$$
x = \begin{bmatrix}\Delta x & \Delta y &\Delta \theta &\Delta \dot x & \Delta \dot y  & \Delta \dot z\end{bmatrix}
$$
容易写出系统的动力学方程：
![[Pasted image 20230926135810.png|500]]

我们定义 MPC 中的 $H$ 步损失函数：
$$
J = \sum_{n=1}^{H-1}  \frac{1}{2} (x_{n} - x_{ref})^{T} Q (x_{n} - x_{ref}) + \frac{1}{2} \Delta u_{n}^{T} R \Delta u_{n}  + \frac{1}{2} (x_{H} - x_{ref})^{T}P_{H}(x_{H} - x_{ref})
$$
之后求解这个问题即可

总之，你会发现“模型预测控制”中没有太多的数学，这是一个基于工程实际情况提出的控制器。但是这的确是一个好用的闭环控制器。





