#MLorDS 

事务 (Transaction)是用户定义的一个数据库操作序列，这些操作要么全做，要么全不做，是一个不可分割的工作单位 
事务和程序： – 在关系数据库中，一个事务可以是一条 SQL 语句，一组 SQL 语句或整个程序 – 一个应用程序通常包含多个事务

定义事务：有两种
```SQL
BEGIN TRANSACTION 
[COMMIT|ROLLBACK]
```

事物包括四个特性：
- 原子性：一个事务是独立的个体，各个操作要么做要么不做
- 一致性：数据库中只包含成功事务提交的结果
- 隔离性：并发的各个事务之间不能互相干扰
- 持续性：事务应该永久地改变数据库中的内容，不受其他操作影响
- 
因此，我们需要有并发控制机制和恢复机制。

数据库恢复技术的基本原理是**冗余数据**

## 数据的转储和恢复
定义：DBA 定期地将整个数据库复制到磁带、磁盘或者其他存储介质上保存起来的过程 ➢这些备用的数据称为后备副本或后援副本，说人话，定期复制副本，就和游戏存档一样！
![[Pasted image 20230330132720.png|400]]

- 静态转储：系统中不能存在运行的事务，不允许对数据库进行修改和存储活动。这种做法简单，但是不能保证数据库的可用性。
- 动态转储：转储操作与用户事务并发进行，这不会等待事务的结束，也不影响新事物的进行。但是这会导致转储得到的副本中的值准确有效。
- 海量转储：转储全部数据
- 增量转储：只转储更新过的数据

## 基于日志的数据库恢复
### 格式和内容
- 以记录为单位的日志文件：日志记录类型：事务的开始标记、结束标记以 及所有更新操作 • 日志记录内容：事务标识、操作类型、操作对 象、更新前后数据的旧值和新值
- 以数据块为单位的日志文件：日志记录内容：事务标识、被更新的数据块的新旧值

作用：
- 事务故障恢复和系统故障恢复必须用日志文件 
- 介质故障恢复可以配合使用日志文件 
- 在动态转储方式中必须建立日志文件，后备副本与该日志文件综合起来才能将数据库恢复到一致性状态 
- 与静态转储后备副本配合进行介质故障恢复（使用日志文件，可以恢复到故障发生前的某一时刻的状态）

### 登记与恢复过程
- 登记的次序严格按并行事务执行的时间次序 
- 必须先写日志文件，后写数据库

Redo 技术 – 针对发生故障时已经完成的事务，可以用 Redo 操作重做 
Undo 技术 – 针对发生故障时还没有提交但是已经在过程中修改了数据库的事务，可以利用 Undo 操作撤销事务 – 如果需要 Undo 的操作有多个，那么 Undo 操作的顺序必须与写入日志时的顺序相反

## 具体的恢复策略
### 事务故障：事务在正常终止点前被中止
恢复方法：利用日志文件撤销事务已对数据库进行的更改，系统回滚到事务执行前的状态 

◼ 事务故障的恢复由系统自动完成，不需要用户干预
(1) 反向扫描日志文件，查找该事务的更新操作； 
(2) 对该事务的更新操作执行逆操作。即将日志记录中 “更新前的值” 写入数据库； 
(3) 继续反向扫描日志文件，查找该事务的其他更新操作，并做同样处理；
(4) 如此处理下去，直至读到此事务的开始标记，事务故障恢复就完成了

### 系统故障
原因：
– 一些未完成事务对数据库的更新已写入数据库 
– 一些已完成事务对数据库的更新还留在缓冲区没来得及写入数据库

方法：
– Undo 故障发生时未完成的事务 
– Redo 故障发生时已完成的事务

步骤：找到需要进行 Redo 和 Undo 操作的事务，分别执行即可

### 介质故障 ：磁盘上的物理数据和日志文件可能被破坏
重装数据库、重做事务，需要 DBA 介入

恢复到一致性状态：
(1) 装入最新的后备数据库副本，使数据库恢复到最近一次转储时的一致性状态。 – 对于静态转储的数据库副本，装入后数据库即处于一致性状态 – 对于动态转储的数据库副本，还须同时装入转储时刻的日志文件副本,利用与恢复系统故障相同的方法 ( 即 REDO+UNDO), 才能将数据库恢复到一致性状态 

恢复到故障点前的状态：
(2) 装入有关的日志文件副本，重做已完成的事务。 – 首先扫描日志文件，找出故障发生时已提交的事务 的标识，将其记入重做队列。 – 然后正向扫描日志文件，对重做队列中的所有事务 进行重做处理

## 检查点恢复技术
这是因为，很多日志中的操作都早已经被处理过，在恢复时无需重复地处理一次。因此，我们使用检查点技术。

◼ 检查点记录的内容
– 1. 建立检查点时刻所有正在执行的事务清单
– 2. 这些事务最近一个日志记录的地址
◼ 重新开始文件的内容 
– 各个检查点记录在日志文件中的地址

![[Pasted image 20230330135935.png|400]]
– 把日志缓冲区中的内容写入日志文件； 
– 在日志文件中写入一个检查点记录； 
– 把数据库缓冲区的内容写入数据库； **这相当于我们结束了在检查点之前已经完成的事务** 
– 把检查点记录在日志文件中的地址写入重新开始文件

利用检查点恢复数据的步骤：
– (1) 从重新开始文件中找到最后一个检查点记录； 
– (2) 得到检查点时刻的事务清单；把事务清单中的事务列表暂时放入 Undo 队列 
– (3) 从检查点开始正向扫描日志文件， ➢如有新开始的事务 Ti，暂时把 Ti 放入 Undo 队列 ➢如有提交事务 Tj，把 Tj 从 Undo 队列移到 Redo 队列 
– (4) 对 Undo 队列事务进行 UNDO 处理；对 Redo 队列事务进行 REDO 处理
这样，未完成的事务需要撤销，完成的事务需要重做。

![[Pasted image 20230330141201.png|400]]
最后的效果是：所有跨过了检查点的事务，默认会被 Undo，一旦这个事务在系统故障前被提交，就需要被 Redo 

## 镜像数据恢复
说人话，就是把数据存在另一块盘上。一旦主数据库更新，就把更新的数据复制到镜像数据库上！



