#StochasticProcess 

今天，我们终于要研究马尔科夫链的长期行为和稳态分布了。现在，我们首先考虑：转移概率的极限是否存在？这个极限是什么？

我们考虑一个最简单的马氏链：
$$
P = \begin{bmatrix}0 & 1  \\ 1 & 0\end{bmatrix}
$$
这个链的转移概率 $P_{ij}(n)$ 显然都是没有极限的！但是，系统处于两个状态的概率都是 $\dfrac{1}{2}$

首先，我们需要给出马尔科夫链的**周期性**。我们将状态 $i$ 的周期定义为：
$$
d_{i} = \gcd \{k:P_{ii}(k)>0\}
$$
如果 $d_{i}=1$，那么可以回到状态 $i$ 的步数之间是互素的，此时，我们称状态 $i$ 为非周期的。现在，我们说明，两个相通的状态有相同的周期，如果马尔科夫链不可约，则所有状态有相同的周期。我们给出证明：
如果 $\exists m ,P_{ij}(m)>0;\exists n, P_{ji}(n) >0$，$i$ 态的周期为 $d_{i}$，那么我们有 $P_{ii}(m+n)>0$，如果我们称 $R_{i}:=\{k:P_{ii}(k)>0\}$，那么 $m+n \in R_{i}$，从而 $d_{i}$ 整除 $m+n$。
又因为 $\forall k \in R_{j}$，那么 $P_{ii}(m+n+k) >0$，从而仿照上面的推理，$d_{i}$ 整除 $m+k+n$
因此，$d_{i}$ 整除 $m+k+n-m-n=k$，又因为 $k$ 是从 $R_{j}$ 中任意选择的，因此 $d_{i}$ 是 $R_{j}$ 中数的公因子，它整除 $R_{j}$ 的最大公因子 $d_{j}$。同理，对称地重复以上过程，可以得到 $d_{j}$ 整除 $d_{i}$，从而 $d_{i} = d_{j}$。因此，我们证明了结论。

我们不加证明地给出一个定理：如果一个马尔科夫链不可约，且非周期，我们可以推断：
$$
\lim_{n \rightarrow \infty } P_{ij}(n) \rightarrow \pi_{j}
$$

显然，我们一开始举出的例子是有周期的，因此我们不能使用这个结论。为了研究一开始的问题，我们需要再提出**正常返**和**零常返**的概念。我们需要研究 $\lim_{N \rightarrow \infty} \dfrac{1}{N}\sum_{n=1}^{N}P_{ij}(n)$ ，这是一个比之前更弱的极限。如果对于状态 $j$, $\forall i$ 这个极限大于 0，我们称状态 $j$ 为正常返，否则为零常返。显然，对于本节开始的例子，对于任意状态，这个极限的值都为 $\dfrac{1}{2}$，因此是正常返的。

关于这个极限，有一个性质（我们暂时不给出证明）：
$$
\lim_{N \rightarrow \infty} \dfrac{1}{N}\sum_{n=1}^{N}P_{ij}(n) = \dfrac{1}{\sum_{k=1}^{\infty} k f_{jj}(k)}
$$


现在，我们需要考虑 $P_{ij}(n)$ 的极限存在的情况下，我们应该如何计算这个极限？
我们知道：
$$
P(n) = P(1)P(n-1) = P(n-1)P(1)
$$
由于在经过足够多步之后，马氏链转移到（也就是处在）状态 $i$ 的概率已经与初态无关（直观上讲，这是因为初态被“”忘记“了），因此此时的矩阵 $P(n)$ 的每一列都是完全相同的。我们将其记作 $\Pi$，它满足 ：
$$
\Pi  = P(1) \cdot \Pi \quad \Pi  = \Pi  \cdot P(1)
$$
左边这个式子是恒等式，我们只能采用右边这个。我们可以对其形式进行一些简化：令 $\pi = (\pi_{1},\pi_{2},\cdots ,\pi_{n})$，那么，它满的方程是：
$$
\pi = \pi \cdot P
$$
我们将这里的 $\pi$ 称为**极限分布**。

我们要说明，还有另一个分布被称为**平稳分布**，它的特点是：如果 $P (X_{0}=k) = \pi_{k}$，那么 $P (X_{n}=k) = \pi_{k}$。显然，极限分布一定是平稳分布。下面给出简单的证明：
$$
\begin{align*}
P(X_{n} = k) &=  \sum_{l}P(X_{n} = k ,X_{n-1} = l)\\
&= \sum_{l}P(X_{n} = k |X_{n-1} = l)P(X_{n-1} = l)\\
&= \sum_{l} P_{lk} P(X_{n-1} = l)
\end{align*}
$$
使用这个结果，不断递推即可，每次都可以推出 $X_{i}= k$ 的概率是 $\pi_{k}$。注意：平稳分布都可以有，但是极限分布不一定存在！
同时，我们也可以说明，如果极限分布不存在，上面的式子解出了：
$$
\dfrac{1}{N}\sum_{n=1}^{N} P_{ij}(n) \rightarrow \pi_{j}
$$
直观上，这描述了足够长的时间内，系统访问某一状态的次数与总转移次数之比。

我们再看一个点：存在 $\pi \not = 0$，使得 $\pi = \pi P$，这等价于存在 $\pi \not =0$，使得 $P^{T} \pi^{T}=\pi^{T}$，也等价于 $(P-I)^{T} \pi^{T}=0$，因此，矩阵 $P-I$ 一定是奇异的，从而，$P$ 存在一个本征值为 1。由于 $P$ 的行和为 1，因此，$P \cdot \vec 1 = 1 \cdot \vec 1$，因此，$P$ 的一个本征矢量为 $\vec 1$。


>[!EXAMPLE] Ehrenfest Model
>考虑密闭容器中有一个挡板，左右两边都有气体。现在中间开一小孔，我们希望建立一个模型，对挡板左右两侧分子的数目随着时间变化的规律进行刻画。

我们将其状态空间设置为挡板左侧的分子数目 $X_n$。我们建立离散时间马氏链，约定在一个单位时间之内，有且仅有一个分子改变了它所处的区域，且每个分子改变其所处区域的概率相等。现在，我们写出其一步转移概率矩阵。我们来写出几个：
$$
P_{01}=1
$$
这是左侧初始为空，只能由右侧的一个粒子走到左侧。
$$
P_{10} = \dfrac{1}{N} \quad P_{12} = \dfrac{N-1}{ N}
$$
从 1 转移到 0 时，是左侧的一个粒子改变了状态；从 1 转移到 2 时，是右侧 $N-1$ 个粒子中的一个改变了状态。以此类推，转移矩阵长成这个样子：
![[Pasted image 20240224210558.png|350]]
我们使用上面的方程组：
$$
\begin{align*}
\pi_{0}&= \dfrac{1}{N} \pi_{1}\\
\pi_{1} &= \pi_{0}+ \dfrac{2}{N} \pi_{2}\\
\pi_{2}&= \dfrac{N-1}{N} \pi_{1} + \dfrac{3}{N} \pi_{3} \\
\pi_{k} &= \dfrac{N-k-1}{N} \pi_{k-1} + \dfrac{k+1}{N} \pi_{k+1}
\end{align*}
$$
可以递推地求出其稳态分布是：
$$
\pi_{k}= C_{N}^{k}\pi_{0} \quad \pi_{0}= \dfrac{1}{2^{n}}
$$
注意：这个链的周期是 2，因此它没有极限分布。利用前面的从 $i$ 态出发，回到 $i$ 态的时间期望公式，我们知道，透过小孔自由扩散的气体分子确实可能重聚，只不过时间格外漫长。

>[!QUESTION]
>假定在图上有一个随机游走：在每一个节点处，沿着每条边游走的概率是相等的。假如这个极限分布存在，那么极限分布是什么？假定其节点的数量是 $N$，第 $i$ 个节点的度为 $d_{i}$。

显然，通过一些特殊的图我们可以看到：一个点的度越高，它的极限概率也应该越高。答案是：
$$
\pi_{k} = \dfrac{d_{k}}{\sum_{i} d_{i}}
$$
接下来检查这个结果对不对：
$$
\sum_{k=1}^{N} \pi_{k} P_{kl} = \sum_{k=1}^{d_{l}} \dfrac{d_{k}}{\sum_{i}d_{i}} \cdot \dfrac{1}{d_{k}}  =\dfrac{d_{l}}{\sum _{i}d_{i}}
$$
注意：在写第二个等号的时候，我们考察的节点 $k$ 有的和节点 $L$ 连接，有的不连接。显然，只有连结的那些点才满足 $P_{kl} = \dfrac{1}{d_{k}}$，这些点一共有 $d_{l}$ 个。因此我们可以完成验证。使用这个思想，我们提出了**PageRank 算法**。

我们再来讲一个叫做“细致平衡关系”的东西。假如矢量 $\pi = (\pi_{0},\cdots,\pi_{n})$，我们说它满足细致平衡关系，则：
$$
\pi_{i}P_{ij} = \pi_{j} P_{ji}
$$
假设 $\pi_{i}$ 代表着某种物料的分配，这似乎代表着从 $i$ 流向 $j$ 的物料和从 $j$ 流向 $i$ 的物料一致，从而每个状态上的物料都保持不变。这个关系是 $\pi = \pi \cdot P$ 的充分条件。
利用这个结论，我们可以给出 **MCMC 算法**：我们希望给出一个能够生成指定稳态分布的马尔科夫链，从而沿着这个马尔科夫链采样。我们现在的问题是如何根据稳态分布 $\pi$ 构造一步转移矩阵 $P$。
首先，我们任取 $P_{ij}$，再构造出新的转移关系：
$$
\tilde P_{ij} = P_{ij} \min(1,\dfrac{\pi_{j} P_{ji}}{\pi_{i} P_{ij}})
$$
我们要说明，修正后的转移关系满足细致平衡方程！对于左侧：
$$
\begin{align*}
\pi_{i}\tilde P_{ij} &=  \pi_{i}P_{ij}\min(1,\dfrac{\pi_{j} P_{ji}}{\pi_{i} P_{ij}})\\
&= \begin{cases}
\pi_{j}P_{ji}\quad \pi_{j}P_{ji} < \pi_{i}P_{ij}\\
\pi_{i}P_{ij}\quad \pi_{j}P_{ji} > \pi_{i}P_{ij}\\
\end{cases}
\end{align*}
$$
对于右侧：
$$
\begin{align*}
\pi_{j}\tilde P_{ji} &=  \pi_{i}P_{ij}\min(1,\dfrac{\pi_{i} P_{ij}}{\pi_{j} P_{ji}})\\
&= \begin{cases}
\pi_{i}P_{ij}\quad \pi_{i}P_{ij} < \pi_{j}P_{ji}\\
\pi_{j}P_{ji}\quad \pi_{i}P_{ij} > \pi_{j}P_{ji}\\
\end{cases}
\end{align*}
$$
显然我们证成。一个小小的重构就帮我们解决了这个问题！开发出这个算法的人是 Metropolis 和 Hastings。

马尔可夫链的其他典型应用包括 HMM 等等。

